---
# OpenClaw Deployment Ansible Playbook
# Deploy and configure OpenClaw across multiple servers

- name: Deploy OpenClaw
  hosts: openclaw_servers
  become: yes
  vars:
    openclaw_version: "latest"
    node_version: "22"
    gateway_port: 18789
    openclaw_user: "openclaw"
    openclaw_home: "/home/{{ openclaw_user }}"
    openclaw_config_dir: "{{ openclaw_home }}/.openclaw"
    
  vars_files:
    - vars/secrets.yml  # Encrypted with ansible-vault
  
  tasks:
    # Pre-flight checks
    - name: Check system requirements
      block:
        - name: Get total RAM
          shell: free -g | awk '/^Mem:/{print $2}'
          register: total_ram
          changed_when: false
        
        - name: Fail if insufficient RAM
          fail:
            msg: "Insufficient RAM. Need at least 2GB, found {{ total_ram.stdout }}GB"
          when: total_ram.stdout | int < 2
        
        - name: Check disk space
          shell: df -BG / | awk 'NR==2 {print $4}' | sed 's/G//'
          register: disk_space
          changed_when: false
        
        - name: Show disk space available
          debug:
            msg: "Disk space available: {{ disk_space.stdout }}GB (minimum required: {{ min_disk_gb | default(2) }}GB)"
        
        - name: Warn if insufficient disk (but continue)
          debug:
            msg: "WARNING: Disk space is lower than recommended. You have {{ disk_space.stdout }}GB, recommended is {{ min_disk_gb | default(2) }}GB or more."
          when: disk_space.stdout | int < (min_disk_gb | default(2) | int)
    
    # System packages
    - name: Update apt cache
      apt:
        update_cache: yes
        cache_valid_time: 3600
      when: ansible_os_family == "Debian"
    
    - name: Install system dependencies
      apt:
        name:
          - curl
          - git
          - build-essential
          - ufw
          - fail2ban
          - htop
          - vim
          - tmux
          - python3-pip
        state: present
      when: ansible_os_family == "Debian"
    
    # Node.js installation
    - name: Add NodeSource repository
      shell: curl -fsSL https://deb.nodesource.com/setup_{{ node_version }}.x | bash -
      args:
        creates: /etc/apt/sources.list.d/nodesource.list
      when: ansible_os_family == "Debian"
    
    - name: Install Node.js
      apt:
        name: nodejs
        state: present
      when: ansible_os_family == "Debian"
    
    - name: Verify Node.js version
      command: node --version
      register: node_version_output
      changed_when: false
    
    - name: Display Node.js version
      debug:
        msg: "Node.js version: {{ node_version_output.stdout }}"
    
    # User setup
    - name: Create openclaw user
      user:
        name: "{{ openclaw_user }}"
        shell: /bin/bash
        create_home: yes
        groups: sudo
        append: yes
    
    - name: Create .openclaw directory
      file:
        path: "{{ openclaw_config_dir }}"
        state: directory
        owner: "{{ openclaw_user }}"
        group: "{{ openclaw_user }}"
        mode: '0700'
    
    # Configure npm global directory
    - name: Create npm global directory
      file:
        path: "{{ openclaw_home }}/.npm-global"
        state: directory
        owner: "{{ openclaw_user }}"
        group: "{{ openclaw_user }}"
      become_user: "{{ openclaw_user }}"
    
    - name: Configure npm prefix
      command: npm config set prefix '{{ openclaw_home }}/.npm-global'
      become_user: "{{ openclaw_user }}"
    
    - name: Add npm global bin to PATH
      lineinfile:
        path: "{{ openclaw_home }}/.bashrc"
        line: 'export PATH={{ openclaw_home }}/.npm-global/bin:$PATH'
        create: yes
        owner: "{{ openclaw_user }}"
        group: "{{ openclaw_user }}"
    
    # Swap configuration
    - name: Check if swap exists
      stat:
        path: /swapfile
      register: swap_file
    
    - name: Create swap file
      command: fallocate -l 4G /swapfile
      when: not swap_file.stat.exists
    
    - name: Set swap permissions
      file:
        path: /swapfile
        mode: '0600'
      when: not swap_file.stat.exists
    
    - name: Format swap
      command: mkswap /swapfile
      when: not swap_file.stat.exists
    
    - name: Enable swap
      command: swapon /swapfile
      when: not swap_file.stat.exists
    
    - name: Add swap to fstab
      lineinfile:
        path: /etc/fstab
        line: '/swapfile none swap sw 0 0'
      when: not swap_file.stat.exists
    
    # OpenClaw installation
    - name: Install OpenClaw globally
      npm:
        name: openclaw
        global: yes
        version: "{{ openclaw_version }}"
        executable: "{{ openclaw_home }}/.npm-global/bin/npm"
      become_user: "{{ openclaw_user }}"
      environment:
        PATH: "{{ openclaw_home }}/.npm-global/bin:{{ ansible_env.PATH }}"
    
    # Configuration files
    - name: Create environment file
      template:
        src: templates/openclaw.env.j2
        dest: "{{ openclaw_config_dir }}/.env"
        owner: "{{ openclaw_user }}"
        group: "{{ openclaw_user }}"
        mode: '0600'
    
    - name: Create OpenClaw config
      template:
        src: templates/openclaw.json.j2
        dest: "{{ openclaw_config_dir }}/openclaw.json"
        owner: "{{ openclaw_user }}"
        group: "{{ openclaw_user }}"
        mode: '0644'
    
    # Systemd service
    - name: Create systemd service
      template:
        src: templates/openclaw.service.j2
        dest: /etc/systemd/system/openclaw.service
        mode: '0644'
      notify: Restart OpenClaw
    
    - name: Enable OpenClaw service
      systemd:
        name: openclaw
        enabled: yes
        daemon_reload: yes
    
    # Firewall configuration
    - name: Configure UFW defaults
      ufw:
        direction: "{{ item.direction }}"
        policy: "{{ item.policy }}"
      loop:
        - { direction: 'incoming', policy: 'deny' }
        - { direction: 'outgoing', policy: 'allow' }
    
    - name: Allow SSH
      ufw:
        rule: allow
        port: '22'
        proto: tcp
    
    - name: Allow OpenClaw gateway
      ufw:
        rule: allow
        port: "{{ gateway_port }}"
        proto: tcp
        from_ip: "{{ item }}"
      loop: "{{ allowed_ips }}"
      when: allowed_ips is defined
    
    - name: Enable UFW
      ufw:
        state: enabled
    
    # Security hardening
    - name: Configure fail2ban
      systemd:
        name: fail2ban
        state: started
        enabled: yes
    
    - name: Set timezone
      timezone:
        name: UTC
    
    # Health check
    - name: Wait for OpenClaw to start
      wait_for:
        port: "{{ gateway_port }}"
        delay: 10
        timeout: 60
    
    - name: Run OpenClaw health check
      command: "{{ openclaw_home }}/.npm-global/bin/openclaw doctor"
      become_user: "{{ openclaw_user }}"
      register: health_check
      ignore_errors: yes
    
    - name: Display health check results
      debug:
        var: health_check.stdout_lines
  
  handlers:
    - name: Restart OpenClaw
      systemd:
        name: openclaw
        state: restarted
        daemon_reload: yes

# Post-deployment verification
- name: Verify deployment
  hosts: openclaw_servers
  become: yes
  tasks:
    - name: Check OpenClaw status
      command: systemctl status openclaw
      register: service_status
      changed_when: false
    
    - name: Display service status
      debug:
        var: service_status.stdout_lines
    
    - name: Test gateway health
      uri:
        url: "http://localhost:{{ gateway_port }}/health"
        method: GET
        status_code: 200
      register: health_response
      ignore_errors: yes
    
    - name: Display health response
      debug:
        var: health_response
