#cloud-config

# OpenClaw Cloud-Init Configuration
# Automated server setup for VPS deployments

package_update: true
package_upgrade: true

packages:
  - curl
  - git
  - build-essential
  - ufw
  - fail2ban
  - htop
  - vim
  - tmux

# Create openclaw user
users:
  - name: openclaw
    groups: sudo
    shell: /bin/bash
    sudo: ['ALL=(ALL) NOPASSWD:ALL']
    ssh_authorized_keys:
      - ${ssh_public_key}

write_files:
  # Environment configuration
  - path: /home/openclaw/.openclaw/.env
    owner: openclaw:openclaw
    permissions: '0600'
    content: |
      OPENCLAW_GATEWAY_TOKEN=${gateway_token}
      ANTHROPIC_API_KEY=${anthropic_api_key}
      OPENCLAW_PORT=18789
      NODE_ENV=${environment}
      LOG_LEVEL=info
  
  # OpenClaw configuration
  - path: /home/openclaw/.openclaw/openclaw.json
    owner: openclaw:openclaw
    permissions: '0644'
    content: |
      {
        "channels": {
          "whatsapp": {
            "enabled": true,
            "allowFrom": [],
            "groups": {
              "*": {
                "requireMention": true
              }
            }
          },
          "telegram": {
            "enabled": false
          },
          "discord": {
            "enabled": false
          }
        },
        "gateway": {
          "port": 18789,
          "host": "0.0.0.0",
          "token": "${gateway_token}"
        },
        "security": {
          "exec": {
            "ask": "on"
          }
        },
        "ai": {
          "defaultProvider": "anthropic",
          "defaultModel": "claude-sonnet-4-20250514"
        },
        "messages": {
          "groupChat": {
            "mentionPatterns": ["@openclaw", "openclaw"]
          }
        }
      }
  
  # Systemd service file
  - path: /etc/systemd/system/openclaw.service
    permissions: '0644'
    content: |
      [Unit]
      Description=OpenClaw Gateway Service
      After=network-online.target
      Wants=network-online.target
      
      [Service]
      Type=simple
      User=openclaw
      Group=openclaw
      WorkingDirectory=/home/openclaw
      Environment="PATH=/usr/bin:/usr/local/bin:/home/openclaw/.npm-global/bin"
      EnvironmentFile=/home/openclaw/.openclaw/.env
      ExecStart=/home/openclaw/.npm-global/bin/openclaw gateway --port 18789
      Restart=always
      RestartSec=10
      StandardOutput=journal
      StandardError=journal
      SyslogIdentifier=openclaw
      
      # Security hardening
      NoNewPrivileges=true
      PrivateTmp=true
      ProtectSystem=strict
      ProtectHome=true
      ReadWritePaths=/home/openclaw
      
      [Install]
      WantedBy=multi-user.target
  
  # Firewall configuration script
  - path: /tmp/setup-firewall.sh
    permissions: '0755'
    content: |
      #!/bin/bash
      set -e
      
      # Configure UFW
      ufw --force reset
      ufw default deny incoming
      ufw default allow outgoing
      
      # Allow SSH
      ufw allow 22/tcp
      
      # Allow OpenClaw gateway (restrict to VPN/specific IPs in production)
      ufw allow 18789/tcp
      
      # Enable firewall
      ufw --force enable
      
      # Configure fail2ban
      systemctl enable fail2ban
      systemctl start fail2ban
  
  # Installation script
  - path: /tmp/install-openclaw.sh
    permissions: '0755'
    content: |
      #!/bin/bash
      set -e
      
      # Install Node.js 22
      curl -fsSL https://deb.nodesource.com/setup_22.x | bash -
      apt-get install -y nodejs
      
      # Configure npm global directory for openclaw user
      su - openclaw -c 'mkdir -p ~/.npm-global'
      su - openclaw -c 'npm config set prefix ~/.npm-global'
      
      # Add npm global bin to PATH
      echo 'export PATH=~/.npm-global/bin:$PATH' >> /home/openclaw/.bashrc
      
      # Install OpenClaw
      su - openclaw -c 'npm install -g openclaw@latest'
      
      # Create workspace directory
      su - openclaw -c 'mkdir -p ~/openclaw/workspace'
      
      # Initialize configuration directory
      su - openclaw -c 'mkdir -p ~/.openclaw'
      
      # Set proper permissions
      chown -R openclaw:openclaw /home/openclaw/.openclaw
      chmod 700 /home/openclaw/.openclaw
      
      # Enable and start service
      systemctl daemon-reload
      systemctl enable openclaw
      systemctl start openclaw
      
      # Wait for service to start
      sleep 10
      
      # Run health check
      su - openclaw -c 'openclaw doctor || true'
      su - openclaw -c 'openclaw status || true'

runcmd:
  # System setup
  - timedatectl set-timezone UTC
  - hostnamectl set-hostname openclaw-${environment}
  
  # Security hardening
  - /tmp/setup-firewall.sh
  
  # Install OpenClaw
  - /tmp/install-openclaw.sh
  
  # Setup swap (4GB)
  - |
    if [ ! -f /swapfile ]; then
      fallocate -l 4G /swapfile
      chmod 600 /swapfile
      mkswap /swapfile
      swapon /swapfile
      echo '/swapfile none swap sw 0 0' >> /etc/fstab
    fi
  
  # Enable automatic security updates
  - |
    apt-get install -y unattended-upgrades
    echo 'Unattended-Upgrade::Automatic-Reboot "false";' >> /etc/apt/apt.conf.d/50unattended-upgrades
  
  # Cleanup
  - apt-get autoremove -y
  - apt-get clean

# Reboot after cloud-init completes (optional)
# power_state:
#   mode: reboot
#   message: "Rebooting after initial setup"
#   timeout: 30

# Send completion notification
phone_home:
  url: https://your-webhook-url.com/cloud-init-complete
  post: all
  tries: 10
