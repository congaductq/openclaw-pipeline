services:
  openclaw:
    image: ghcr.io/openclaw/openclaw:latest
    container_name: openclaw
    restart: unless-stopped

    ports:
      - "${GATEWAY_PORT:-18789}:18789"

    volumes:
      - openclaw-config:/home/node/.openclaw
      - openclaw-workspace:/home/node/openclaw/workspace

    environment:
      - OPENCLAW_GATEWAY_TOKEN=${OPENCLAW_GATEWAY_TOKEN}
      - OPENCLAW_PORT=18789
      - NODE_ENV=${NODE_ENV:-production}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - GROQ_API_KEY=${GROQ_API_KEY}
      - XAI_API_KEY=${XAI_API_KEY}
      - MISTRAL_API_KEY=${MISTRAL_API_KEY}
      - OPENROUTER_API_KEY=${OPENROUTER_API_KEY}
      - CLAUDE_CODE_OAUTH_TOKEN=${CLAUDE_CODE_OAUTH_TOKEN}
      - DEFAULT_MODEL=${DEFAULT_MODEL:-claude-sonnet-4-5-20250929}
      - DEFAULT_PROVIDER=${DEFAULT_PROVIDER:-anthropic}
      - EXEC_ASK=${EXEC_ASK:-on}
      - LOG_LEVEL=${LOG_LEVEL:-info}
      - LOG_FORMAT=${LOG_FORMAT:-json}

    healthcheck:
      test: ["CMD", "node", "/app/openclaw.mjs", "gateway", "health", "--url", "ws://127.0.0.1:18789"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 4G
        reservations:
          cpus: '1.0'
          memory: 2G

  pipeline-server:
    build:
      context: ./server
      dockerfile: Dockerfile
    container_name: pipeline-server
    restart: unless-stopped

    ports:
      - "${SERVER_PORT:-4000}:4000"

    volumes:
      # Mount the pipeline project so the server can run make commands
      - .:/app/pipeline
      # Mount AWS credentials and SSH keys for terraform/EC2 access
      - ~/.aws:/root/.aws:ro
      - ~/.ssh:/root/.ssh:ro
      # Mount Docker socket so it can run docker commands on host
      - /var/run/docker.sock:/var/run/docker.sock

    environment:
      - SERVER_PORT=4000
      - FRONTEND_URL=${FRONTEND_URL:-http://host.docker.internal:3000}
      - PIPELINE_DIR=/app/pipeline

    depends_on:
      - openclaw

volumes:
  openclaw-config:
    driver: local
  openclaw-workspace:
    driver: local
